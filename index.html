<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easter Egg Hunt Leaderboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- Image Styles --- */
        .egg-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 1rem;
            background-color: #e5e7eb;
            vertical-align: middle;
            cursor: pointer; /* Add pointer cursor to indicate clickability */
            transition: transform 0.2s ease; /* Add slight scale effect on hover */
        }
        .egg-image:hover {
            transform: scale(1.05); /* Slightly enlarge on hover */
        }
        .error-placeholder {
            display: inline-block;
            width: 80px;
            height: 80px;
            background-color: #fee2e2;
            border-radius: 1rem;
            text-align: center;
            line-height: 80px;
            font-size: 0.8rem;
            color: #b91c1c;
            font-weight: bold;
            vertical-align: middle;
        }
        /* --- End Image Styles --- */

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            padding: 20px; /* Add padding for smaller screens */
            box-sizing: border-box;
        }
        .modal-content {
            position: relative;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            max-width: 90vw; /* Max width relative to viewport */
            max-height: 90vh; /* Max height relative to viewport */
            display: flex; /* Use flex to help center image */
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content img {
            display: block;
            max-width: 100%; /* Ensure image fits within content area */
            max-height: calc(90vh - 40px); /* Max height adjusted for padding */
            object-fit: contain; /* Scale image while preserving aspect ratio */
            border-radius: 4px; /* Slight rounding on modal image */
        }
        .modal-close {
            position: absolute;
            top: -10px; /* Position slightly outside the top right */
            right: -10px;
            background: #fff;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 28px; /* Center the 'x' */
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .modal-close:hover {
            background: #eee;
        }
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }
        /* --- End Modal Styles --- */


        /* ... (keep all other existing styles: .header-section, etc.) ... */
        .header-section { background-color: #87fac4; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .recent-activity-container { background-color: #ffea96; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .leaderboard { background-color: #f8fafc; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .progress-container { height: 24px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width 0.5s ease-in-out; border-radius: 9999px; }
        body { background-color: #b4f2fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .placeholder { display: flex; align-items: center; justify-content: center; height: 60px; color: #6b7280; }
        .duplicate-row { background-color: #fee2e2; }
        .duplicate-row:hover { background-color: #fecaca; }
        tr.duplicate-row:hover { background-color: #fecaca !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-5xl">

        <h1 class="text-4xl font-bold text-center text-blue-500 mb-4">Langmuir Easter Egg Hunt Leaderboard</h1>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
             <a href="https://forms.gle/bXcQqKpyvgiebncK6" target="_blank" rel="noopener noreferrer"
                class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-150 ease-in-out text-center w-full sm:w-auto">
                 Mark An Egg As Found
             </a>
             <a href="https://i.imgur.com/o10J8gU.png" id="howToPlayBtn" rel="noopener noreferrer" class="inline-block bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow transition duration-150 ease-in-out text-center w-full sm:w-auto cursor-pointer"> How to Play </a>
        </div>
        <div class="header-section p-6 mb-8">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                 <div>
                     <h2 class="text-xl font-semibold text-gray-700 mb-3">Current Leader</h2>
                     <div id="leader-section">
                         <div class="placeholder animate-pulse bg-gray-200 h-24 w-full rounded">Loading...</div>
                     </div>
                 </div>
                 <div class="recent-activity-container p-4">
                     <h2 class="text-xl font-semibold text-gray-700 mb-3">Most Recent Find</h2>
                     <div id="recent-activity">
                           <div class="placeholder animate-pulse bg-gray-200 h-24 w-full rounded">Loading...</div>
                     </div>
                 </div>
             </div>
             <div class="mt-8">
                 <div class="flex justify-between mb-2">
                     <h2 class="text-xl font-semibold text-gray-700">Overall Progress</h2>
                     <span id="progress-text" class="font-medium">0/48 eggs found</span>
                 </div>
                 <div class="progress-container">
                     <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                 </div>
                 <div id="duplicate-warning" class="text-center text-red-600 font-medium mt-2 h-5"></div>
             </div>
         </div>

        <div class="leaderboard p-6">
             <h2 class="text-2xl font-bold text-gray-800 mb-4">All Finds</h2>
             <div class="overflow-x-auto">
                 <table class="min-w-full bg-white rounded-lg overflow-hidden shadow">
                     <thead class="bg-gray-100">
                         <tr>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Time</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Name</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Egg #</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Image</th>
                         </tr>
                     </thead>
                     <tbody id="leaderboard-body" class="divide-y divide-gray-200">
                         <tr>
                             <td colspan="4" class="text-center py-4 px-4 text-gray-500">Loading data...</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
        </div>

        <div class="mt-6 text-center text-gray-600 text-sm">
            <p>Last updated: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <div id="imageModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="modalCloseBtn">&times;</span>
            <img id="modalImage" src="" alt="Expanded Easter Egg Image">
        </div>
    </div>


    <script>
    // --- Configuration and Setup ---
    let config = {
        sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3GWG7_o4wMLqEebc7rIDpyLp2wPCh4l5j-01R0Pi3oiBHT8G2PUVm75hdt3Az0zgGTiJj-9dobl3J/pub?output=csv',
        totalEggs: 48,
        refreshInterval: 10,
        // <<< START: Added How to Play Image URL >>>
        howToPlayImageUrl: 'https://i.imgur.com/RcFVAN7.png' // Direct link to the How to Play image
        // <<< END: Added How to Play Image URL >>>
    };
    let refreshTimer;

    // --- Modal Elements --- (Define globally or within DOMContentLoaded)
    let imageModal, modalImage, modalCloseBtn, leaderboardBody;


    // --- Main Data Fetching and Processing ---
    async function fetchData() {
        console.log("Fetching data...");
        if (!config.sheetUrl) {
            console.error('No Sheet URL configured');
            updateUIOnError('Error: Google Sheet URL is not configured.');
            return;
        }
        try {
            const response = await fetch(config.sheetUrl);
            if (!response.ok) throw new Error(`Network response not ok: ${response.statusText} (${response.status})`);
            const csvText = await response.text();
            console.log("Data fetched, parsing CSV...");
            const formattedData = parseCSV(csvText);
            if (formattedData === null) return;

            console.log("Processing data for duplicates...");
            const { uniqueEggsCount, duplicateEggNumbers } = processEggData(formattedData);
            console.log(`Found ${uniqueEggsCount} unique eggs, ${duplicateEggNumbers.size} duplicates.`);

            console.log("Updating UI...");
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString([], {year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
            updateLeaderboard(formattedData, duplicateEggNumbers);
            updateLeaderSection(formattedData);
            updateRecentActivity(formattedData);
            updateProgressBar(uniqueEggsCount, duplicateEggNumbers);
            console.log("UI Updated.");
        } catch (error) {
            console.error('Error fetching/processing data:', error);
            updateUIOnError(`Error loading data: ${error.message}. Check console.`);
        }
    }

    /** Parses CSV text */
    function parseCSV(csv) {
        // ... (Keep the robust parseCSV function as before) ...
        try {
            const lines = csv.split(/[\r\n]+/);

            while (lines.length > 0 && !lines[lines.length - 1].trim()) { lines.pop(); }
            if (lines.length <= 1) { return []; }

            const headerLine = lines[0];
            const headersRaw = [];
            let currentHeader = '';
            let inQuotesHeader = false;
            for (let j = 0; j < headerLine.length; j++) {
                const char = headerLine[j];
                if (char === '"' && j + 1 < headerLine.length && headerLine[j + 1] === '"') { currentHeader += '"'; j++; }
                else if (char === '"') { inQuotesHeader = !inQuotesHeader; }
                else if (char === ',' && !inQuotesHeader) { headersRaw.push(currentHeader.trim()); currentHeader = ''; }
                else { currentHeader += char; }
            }
            headersRaw.push(currentHeader.trim());
            const headers = headersRaw.map(h => h.toLowerCase());

            const timestampIndex = headers.indexOf('timestamp');
            const nameIndex = headers.indexOf('name');
            const eggNumberIndex = headers.findIndex(h => h.includes('egg') && h.includes('number'));
            const imageUrlIndex = headers.findIndex(h => h.includes('url') || h.includes('image'));

            if (timestampIndex === -1 || nameIndex === -1 || eggNumberIndex === -1 || imageUrlIndex === -1) {
                 const missing = [(timestampIndex === -1 ? 'timestamp' : null),(nameIndex === -1 ? 'name' : null),(eggNumberIndex === -1 ? 'egg number' : null),(imageUrlIndex === -1 ? 'image url' : null)].filter(Boolean).join(', ');
                 console.error(`Error: Could not find required column(s): ${missing}. Found headers:`, headers);
                 updateUIOnError(`Error: Required column(s) (${missing}) not found in Sheet. Check first row.`);
                 return null;
            }

            const formattedData = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line || !line.trim()) continue;
                const row = [];
                let currentVal = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"' && j + 1 < line.length && line[j + 1] === '"') { currentVal += '"'; j++; }
                    else if (char === '"') { inQuotes = !inQuotes; }
                    else if (char === ',' && !inQuotes) { row.push(currentVal.trim()); currentVal = ''; }
                    else { currentVal += char; }
                }
                row.push(currentVal.trim());
                if (row.length !== headers.length) { console.warn(`Skipping row ${i + 1}: Parsed column count (${row.length}) != header count (${headers.length}). Line: "${line}"`); continue; }

                const rowData = {
                    timestamp: row[timestampIndex] || '', name: row[nameIndex] || '',
                    eggNumber: row[eggNumberIndex] || '', imageUrl: row[imageUrlIndex] || ''
                };
                // More robust timestamp validation
                 let timestampDate = null;
                 try {
                     timestampDate = new Date(rowData.timestamp);
                 } catch (e) { /* ignore parsing error */ }
                 if (!timestampDate || isNaN(timestampDate.getTime())) {
                     console.warn(`Skipping row ${i + 1}: Invalid timestamp "${rowData.timestamp}". Line: "${line}"`);
                     continue;
                 }
                formattedData.push(rowData);
            }

            formattedData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            console.log(`Parsed ${formattedData.length} valid rows.`);
            return formattedData;
        } catch (error) {
            console.error("Error parsing CSV:", error);
            updateUIOnError(`Error parsing data: ${error.message}. Check console.`);
            return null;
        }
    }

    /** Processes data for unique/duplicate eggs */
    function processEggData(data) {
        // ... (Keep the existing processEggData function) ...
       const seenEggs = new Set();
       const duplicateEggNumbers = new Set();
       for (let i = data.length - 1; i >= 0; i--) { // Iterate backwards to identify duplicates correctly based on first seen
           const item = data[i];
           if (item.eggNumber) {
               const eggNumStr = String(item.eggNumber).trim(); // Normalize
               if(eggNumStr) {
                   if (seenEggs.has(eggNumStr)) {
                       duplicateEggNumbers.add(eggNumStr);
                   } else {
                       seenEggs.add(eggNumStr);
                   }
               }
           }
       }
       return { uniqueEggsCount: seenEggs.size, duplicateEggNumbers };
    }

    // --- UI Update Functions ---

    /** Helper function to display errors */
    function updateUIOnError(errorMessage) {
        // ... (Keep the existing updateUIOnError function) ...
        document.getElementById('leaderboard-body').innerHTML = `<tr><td colspan="4" class="text-center py-4 px-4 text-red-600">${errorMessage}</td></tr>`;
        document.getElementById('leader-section').innerHTML = `<div class="placeholder text-red-600 p-4 h-24">${errorMessage}</div>`;
        document.getElementById('recent-activity').innerHTML = `<div class="placeholder text-red-600 p-4 h-24">${errorMessage}</div>`;
        document.getElementById('progress-text').textContent = 'Error';
        document.getElementById('duplicate-warning').textContent = '';
    }

    /** Creates the HTML for an image + adds data attribute for large view */
    function createImageHtml(imageUrl, altText) {
        let fileId = null;
        let largeSrc = ''; // URL for the larger modal image
        let isClickable = false; // Flag to add egg-image class

        // --- Logic to extract fileId and determine largeSrc ---
        try {
            if (typeof imageUrl === 'string' && imageUrl.includes('drive.google.com')) {
                 if (imageUrl.includes('/file/d/')) {
                     const match = imageUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                     if (match && match[1]) fileId = match[1];
                 } else if (imageUrl.includes('open?id=')) {
                     const urlParams = new URLSearchParams(new URL(imageUrl).search);
                     fileId = urlParams.get('id');
                 } else if (imageUrl.includes('/uc?id=')) {
                      const urlParams = new URLSearchParams(new URL(imageUrl).search);
                     fileId = urlParams.get('id');
                 }
            }
        } catch (e) { console.error("Error parsing Google Drive URL:", imageUrl, e); }

        if (fileId) {
            // Use Google Drive thumbnail API for both small and large versions
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w200`; // Thumbnail size
            largeSrc = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`; // Larger size for modal
            isClickable = true; // Make Drive images clickable
             const errorTitle = `Failed to load thumbnail. URL: ${thumbnailUrl} (Original: ${imageUrl || 'N/A'}) - Check sharing permissions?`;
            // Return the img tag with thumbnail, large source data, error fallback
            // Added referrerpolicy="no-referrer" to potentially help with Drive image loading issues
            return `<img src="${thumbnailUrl}" alt="${altText}" class="egg-image" data-large-src="${largeSrc}" referrerpolicy="no-referrer" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" >` +
                   `<div class="error-placeholder" style="display: none;" title="${errorTitle}">Img Err</div>`;

        } else if (typeof imageUrl === 'string' && !imageUrl.includes('drive.google.com') && imageUrl.trim() !== '') {
            // Handle non-Drive, non-empty URLs - use the same URL for thumbnail and large view
            largeSrc = imageUrl;
            isClickable = true; // Also make these clickable
             // Added referrerpolicy="no-referrer"
            return `<img src="${imageUrl}" alt="${altText || 'Image'}" class="egg-image" data-large-src="${largeSrc}" referrerpolicy="no-referrer" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" >` +
                   `<div class="error-placeholder" style="display: none;" title="Image failed to load. Original URL: ${imageUrl}">Img Err</div>`;
        } else {
            // Invalid, empty, or unparsable Drive URL - show placeholder, not clickable
            console.warn("Could not get valid image source for:", imageUrl);
            return `<div class="error-placeholder" title="Invalid or missing image URL. Original: ${imageUrl || 'N/A'}">No Img</div>`;
        }
    }

    /** Updates leaderboard table */
    function updateLeaderboard(data, duplicateEggNumbers) {
         const tbody = document.getElementById('leaderboard-body');
         tbody.innerHTML = '';
         if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 px-4 text-gray-500">No egg finds recorded yet.</td></tr>'; return; }

         data.forEach(item => {
             const row = document.createElement('tr');
             const eggNumStr = String(item.eggNumber || '').trim(); // Normalize
             const isDuplicateNumber = eggNumStr && duplicateEggNumbers.has(eggNumStr);

              if (isDuplicateNumber) { row.className = 'duplicate-row'; row.title = `Egg ${eggNumStr} was found more than once!`; }
              else { row.className = 'hover:bg-gray-50'; }

             let formattedDate = 'Invalid Date'; try { const date = new Date(item.timestamp); if (!isNaN(date)) { formattedDate = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }); } } catch(e) {/* ignore */}
             // createImageHtml now returns the appropriate img or placeholder
             const imageHtml = createImageHtml(item.imageUrl, `Egg ${eggNumStr || ''} found by ${item.name || 'Unknown'}`);

             row.innerHTML = `
                 <td class="px-4 py-3 whitespace-nowrap text-sm align-middle">${formattedDate}</td>
                 <td class="px-4 py-3 whitespace-nowrap text-sm font-medium align-middle">${item.name || 'N/A'}</td>
                 <td class="px-4 py-3 whitespace-nowrap text-sm align-middle">${eggNumStr || 'N/A'}</td>
                 <td class="px-4 py-3 align-middle">${imageHtml}</td>
             `;
             tbody.appendChild(row);
         });
     }


    /** Updates the leader section */
    function updateLeaderSection(data) {
        const leaderSection = document.getElementById('leader-section');
        if (!data || data.length === 0) { leaderSection.innerHTML = '<div class="placeholder text-gray-500 h-24">No data available</div>'; return; }
        const playerCounts = {}; const playerLastImageUrl = {};
        data.forEach(item => { if (item.name) { if (!playerCounts[item.name]) { playerCounts[item.name] = 0; playerLastImageUrl[item.name] = item.imageUrl; } playerCounts[item.name]++; } });
        let leader = ''; let maxEggs = 0; let leaderImageUrl = '';
        // Find the leader based on maximum unique eggs first, then by count if tie
        // This requires knowing unique eggs per player, let's simplify back to total count for now
         for (const player in playerCounts) { if (playerCounts[player] > maxEggs) { maxEggs = playerCounts[player]; leader = player; leaderImageUrl = playerLastImageUrl[player]; } }

        if (leader) {
            // Use createImageHtml but make sure it's not clickable in this context
            const imageHtml = createImageHtml(leaderImageUrl, `Latest find by ${leader}`);
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = imageHtml;
            const img = tempDiv.querySelector('img.egg-image'); // Target only clickable images
            if (img) {
                img.classList.remove('egg-image'); // Remove class that adds cursor:pointer and hover effect
                img.style.cursor = 'default';       // Explicitly set default cursor
                 // Also remove the large source data attribute if not needed
                 img.removeAttribute('data-large-src');
            }
             const errorPlaceholder = tempDiv.querySelector('.error-placeholder');
             if (errorPlaceholder) errorPlaceholder.style.cursor = 'default'; // Make placeholder non-interactive too

            leaderSection.innerHTML = `<div class="flex items-center p-3 bg-blue-50 rounded-lg"><div class="mr-4 flex-shrink-0">${tempDiv.innerHTML}</div><div class="flex-grow"><h3 class="font-bold text-lg text-gray-800">${leader}</h3><p class="text-sm text-gray-600">${maxEggs} egg${maxEggs !== 1 ? 's' : ''} found</p></div></div>`;
         } else {
             leaderSection.innerHTML = '<div class="placeholder text-gray-500 h-24">No leader yet.</div>';
         }
    }

    /** Updates recent activity */
    function updateRecentActivity(data) {
        const recentActivity = document.getElementById('recent-activity');
        if (!data || data.length === 0) { recentActivity.innerHTML = '<div class="placeholder text-gray-500 h-24">No recent activity</div>'; return; }
        const mostRecent = data[0]; // Data is sorted descending by timestamp
        if (mostRecent && mostRecent.name) {
             const imageHtml = createImageHtml(mostRecent.imageUrl, `Egg ${mostRecent.eggNumber || ''}`);
             // Make sure image is not clickable in this context
             const tempDiv = document.createElement('div'); tempDiv.innerHTML = imageHtml;
             const img = tempDiv.querySelector('img.egg-image'); // Target only clickable images
             if (img) {
                 img.classList.remove('egg-image'); // Remove class that adds cursor:pointer and hover effect
                 img.style.cursor = 'default';       // Explicitly set default cursor
                  // Also remove the large source data attribute if not needed
                 img.removeAttribute('data-large-src');
             }
             const errorPlaceholder = tempDiv.querySelector('.error-placeholder');
             if (errorPlaceholder) errorPlaceholder.style.cursor = 'default'; // Make placeholder non-interactive too

             recentActivity.innerHTML = `<div class="flex items-center"><div class="mr-3 flex-shrink-0">${tempDiv.innerHTML}</div><div class="flex-grow"><p class="font-semibold text-gray-800">${mostRecent.name}</p><p class="text-sm text-gray-600">Found egg #${mostRecent.eggNumber || '?'}</p></div></div>`;
         } else {
             recentActivity.innerHTML = '<div class="placeholder text-gray-500 h-24">No valid recent activity found</div>';
         }
    }

    /** Updates progress bar AND duplicate warning */
    function updateProgressBar(uniqueEggsCount, duplicateEggNumbers) {
         const eggsFound = uniqueEggsCount;
         const totalEggs = config.totalEggs > 0 ? config.totalEggs : 1; // Avoid division by zero
         const percentage = Math.min(100, Math.max(0, Math.round((eggsFound / totalEggs) * 100)));
         document.getElementById('progress-bar').style.width = `${percentage}%`;
         document.getElementById('progress-text').textContent = `${eggsFound}/${config.totalEggs} unique eggs found`;
         const warningDiv = document.getElementById('duplicate-warning');
         if (duplicateEggNumbers.size > 0) {
            const eggList = Array.from(duplicateEggNumbers).sort((a,b) => a - b).slice(0, 5).join(', '); // Sort numerically
            const extra = duplicateEggNumbers.size > 5 ? '...' : '';
            warningDiv.textContent = `Warning: Duplicate finds for egg(s) #${eggList}${extra}!`;
            warningDiv.title = `Full list of duplicates: ${Array.from(duplicateEggNumbers).sort((a,b) => a - b).join(', ')}`;
        }
         else { warningDiv.textContent = ''; warningDiv.title = ''; }
    }

    /** Starts the refresh timer */
    function startRefreshTimer() {
        if (refreshTimer) { clearInterval(refreshTimer); }
        const intervalMs = Math.max(5000, config.refreshInterval * 1000); // Minimum 5 seconds
        console.log(`Setting refresh interval to ${intervalMs / 1000} seconds.`);
        refreshTimer = setInterval(fetchData, intervalMs);
    }

    /** Shows the image modal */
    function showModal(largeImageUrl, altText) {
        if (!imageModal || !modalImage || !largeImageUrl) {
            console.error("Modal elements or image URL missing for showModal");
            return;
        }
        console.log("Showing modal for:", largeImageUrl);
        modalImage.src = largeImageUrl;
        modalImage.alt = altText || "Expanded Image";
        imageModal.style.display = 'flex'; // Show the modal
        document.body.classList.add('modal-open'); // Prevent background scroll
    }

    /** Hides the image modal */
    function hideModal() {
        if (!imageModal || !modalImage) return;
        imageModal.style.display = 'none'; // Hide the modal
        modalImage.src = ''; // Clear src to stop loading/free memory
        modalImage.alt = '';
        document.body.classList.remove('modal-open'); // Restore background scroll
    }

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Loaded. Initializing...");

        // Get modal elements
        imageModal = document.getElementById('imageModal');
        modalImage = document.getElementById('modalImage');
        modalCloseBtn = document.getElementById('modalCloseBtn');
        leaderboardBody = document.getElementById('leaderboard-body');

        // Get How to Play button
        const howToPlayButton = document.getElementById('howToPlayBtn');


        // --- Event Listeners ---

        // Close Modal Button
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', hideModal);
        } else { console.error("Modal close button not found."); }

        // Click outside Modal content to close
        if (imageModal) {
            imageModal.addEventListener('click', (event) => {
                if (event.target === imageModal) { // Check if the click is on the overlay itself
                    hideModal();
                }
            });
        } else { console.error("Modal overlay not found."); }

        // Escape key to close Modal
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && imageModal && imageModal.style.display === 'flex') {
                hideModal();
            }
        });

        // Click on Leaderboard image to open Modal (Event Delegation)
        if (leaderboardBody) {
            leaderboardBody.addEventListener('click', (event) => {
                const clickedImage = event.target.closest('img.egg-image[data-large-src]');
                if (clickedImage) {
                    const largeSrc = clickedImage.dataset.largeSrc;
                    if (largeSrc) {
                        showModal(largeSrc, clickedImage.alt);
                    } else {
                        console.warn("Clicked image doesn't have a valid data-large-src attribute value.");
                    }
                }
            });
        } else {
            console.error("Leaderboard body not found for event listener attachment.");
        }

        // <<< START: Added How to Play Button Listener >>>
        if (howToPlayButton) {
             howToPlayButton.addEventListener('click', (event) => {
                 event.preventDefault(); // Stop the link from navigating
                 if (config.howToPlayImageUrl) {
                    showModal(config.howToPlayImageUrl, 'How to Play Guide');
                 } else {
                     console.error("How to Play image URL is not configured.");
                     // Optionally show an alert to the user
                     alert("Sorry, the 'How to Play' guide image is currently unavailable.");
                 }
             });
        } else {
             console.error("How to Play button (#howToPlayBtn) not found.");
        }
        // <<< END: Added How to Play Button Listener >>>


        // --- Initial Data Load and Timer Start ---
        fetchData(); // Initial fetch
        startRefreshTimer(); // Start refreshing data
    });
    </script>
</body>
</html>