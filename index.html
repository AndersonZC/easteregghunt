<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easter Egg Hunt Leaderboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- Updated Image Styles --- */
        .egg-image {
            width: 80px; /* Increased size */
            height: 80px; /* Increased size */
            object-fit: cover;
            border-radius: 1rem; /* Squircle shape (adjust value as needed, e.g., '25%') */
            background-color: #e5e7eb; /* Light gray background for loading */
            vertical-align: middle; /* Align nicely with text */
        }
        .error-placeholder {
            display: inline-block;
            width: 80px; /* Match egg-image size */
            height: 80px; /* Match egg-image size */
            background-color: #fee2e2; /* Light red background */
            border-radius: 1rem; /* Match egg-image shape */
            text-align: center;
            line-height: 80px; /* Match height to vertically center text */
            font-size: 0.8rem; /* Slightly larger text for the bigger box */
            color: #b91c1c; /* Dark red text */
            font-weight: bold;
            vertical-align: middle; /* Align nicely with text */
        }
        /* --- End Updated Image Styles --- */

        /* ... (keep all other existing styles: .header-section, .recent-activity-container, etc.) ... */
        .header-section { background-color: #f0f9ff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .recent-activity-container { background-color: #fffbeb; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .leaderboard { background-color: #f8fafc; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .progress-container { height: 24px; background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width 0.5s ease-in-out; border-radius: 9999px; }
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .placeholder { display: flex; align-items: center; justify-content: center; height: 60px; color: #6b7280; } /* Note: Placeholder height might need adjustment if content pushes it */
        .duplicate-row { background-color: #fee2e2; }
        .duplicate-row:hover { background-color: #fecaca; }
        tr.duplicate-row:hover { background-color: #fecaca !important; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-5xl">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">Easter Egg Hunt Leaderboard</h1>

        <div class="header-section p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center"> <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">Current Leader</h2>
                    <div id="leader-section">
                        <div class="placeholder animate-pulse bg-gray-200 h-24 w-full rounded">Loading...</div> </div>
                </div>

                <div class="recent-activity-container p-4">
                    <h2 class="text-xl font-semibold text-amber-700 mb-3">Most Recent Find</h2>
                    <div id="recent-activity">
                          <div class="placeholder animate-pulse bg-gray-200 h-24 w-full rounded">Loading...</div> </div>
                </div>
            </div>

            <div class="mt-8">
                <div class="flex justify-between mb-2">
                    <h2 class="text-xl font-semibold text-gray-700">Overall Progress</h2>
                    <span id="progress-text" class="font-medium">0/48 eggs found</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div id="duplicate-warning" class="text-center text-red-600 font-medium mt-2 h-5"></div>
            </div>
        </div>

        <div class="leaderboard p-6">
             <h2 class="text-2xl font-bold text-gray-800 mb-4">All Finds</h2>
             <div class="overflow-x-auto">
                 <table class="min-w-full bg-white rounded-lg overflow-hidden shadow">
                     <thead class="bg-gray-100">
                         <tr>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Time</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Name</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Egg #</th>
                             <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Image</th>
                         </tr>
                     </thead>
                     <tbody id="leaderboard-body" class="divide-y divide-gray-200">
                         <tr>
                             <td colspan="4" class="text-center py-4 px-4 text-gray-500">Loading data...</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
        </div>

        <div class="mt-6 text-center text-gray-600 text-sm">
            <p>Last updated: <span id="last-updated">Never</span></p>
        </div>
    </div>

    <script>
    // --- Configuration and Setup ---
    let config = {
        sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3GWG7_o4wMLqEebc7rIDpyLp2wPCh4l5j-01R0Pi3oiBHT8G2PUVm75hdt3Az0zgGTiJj-9dobl3J/pub?output=csv', // Ensure correct PUBLISHED CSV URL
        totalEggs: 48,
        refreshInterval: 10
    };
    let refreshTimer;

    // --- Main Data Fetching and Processing ---
    async function fetchData() {
        // ... (Keep existing fetchData logic) ...
        console.log("Fetching data...");
        if (!config.sheetUrl) {
            console.error('No Sheet URL configured');
            updateUIOnError('Error: Google Sheet URL is not configured.');
            return;
        }

        try {
            const response = await fetch(config.sheetUrl);
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText} (Status: ${response.status})`);
            }

            const csvText = await response.text();
            console.log("Data fetched, parsing CSV...");
            const formattedData = parseCSV(csvText);

            if (formattedData === null) { return; } // Stop if parsing failed

            console.log("Processing data for duplicates...");
            const { uniqueEggsCount, duplicateEggNumbers } = processEggData(formattedData);
            console.log(`Found ${uniqueEggsCount} unique eggs, ${duplicateEggNumbers.size} duplicate numbers.`);

            console.log("Updating UI...");
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            updateLeaderboard(formattedData, duplicateEggNumbers);
            updateLeaderSection(formattedData);
            updateRecentActivity(formattedData);
            updateProgressBar(uniqueEggsCount, duplicateEggNumbers);
            console.log("UI Updated.");

        } catch (error) {
            console.error('Error fetching or processing data:', error);
            updateUIOnError(`Error loading data: ${error.message}. Check console.`);
        }
    }

    /** Parses CSV text (robust version) */
    function parseCSV(csv) {
        // ... (Keep the robust parseCSV function) ...
        try {
            const lines = csv.split(/[\r\n]+/);

            while (lines.length > 0 && !lines[lines.length - 1].trim()) { lines.pop(); }
            if (lines.length <= 1) { return []; }

            const headerLine = lines[0];
            const headersRaw = [];
            let currentHeader = '';
            let inQuotesHeader = false;
            for (let j = 0; j < headerLine.length; j++) {
                const char = headerLine[j];
                if (char === '"' && j + 1 < headerLine.length && headerLine[j + 1] === '"') { currentHeader += '"'; j++; }
                else if (char === '"') { inQuotesHeader = !inQuotesHeader; }
                else if (char === ',' && !inQuotesHeader) { headersRaw.push(currentHeader.trim()); currentHeader = ''; }
                else { currentHeader += char; }
            }
            headersRaw.push(currentHeader.trim());
            const headers = headersRaw.map(h => h.toLowerCase());

            const timestampIndex = headers.indexOf('timestamp');
            const nameIndex = headers.indexOf('name');
            const eggNumberIndex = headers.findIndex(h => h.includes('egg') && h.includes('number'));
            const imageUrlIndex = headers.findIndex(h => h.includes('url') || h.includes('image'));

            if (timestampIndex === -1 || nameIndex === -1 || eggNumberIndex === -1 || imageUrlIndex === -1) {
                 const missing = [(timestampIndex === -1 ? 'timestamp' : null),(nameIndex === -1 ? 'name' : null),(eggNumberIndex === -1 ? 'egg number' : null),(imageUrlIndex === -1 ? 'image url' : null)].filter(Boolean).join(', ');
                 console.error(`Error: Could not find required column(s): ${missing}. Found headers:`, headers);
                 updateUIOnError(`Error: Required column(s) (${missing}) not found in Sheet. Check first row.`);
                 return null;
            }

            const formattedData = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line || !line.trim()) continue;
                const row = [];
                let currentVal = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"' && j + 1 < line.length && line[j + 1] === '"') { currentVal += '"'; j++; }
                    else if (char === '"') { inQuotes = !inQuotes; }
                    else if (char === ',' && !inQuotes) { row.push(currentVal.trim()); currentVal = ''; }
                    else { currentVal += char; }
                }
                row.push(currentVal.trim());
                if (row.length !== headers.length) { console.warn(`Skipping row ${i + 1}: Parsed column count (${row.length}) != header count (${headers.length}). Line: "${line}"`); continue; }

                const rowData = {
                    timestamp: row[timestampIndex] || '', name: row[nameIndex] || '',
                    eggNumber: row[eggNumberIndex] || '', imageUrl: row[imageUrlIndex] || ''
                };
                if (isNaN(new Date(rowData.timestamp).getTime())) { console.warn(`Skipping row ${i + 1}: Invalid timestamp "${rowData.timestamp}". Line: "${line}"`); continue; }
                formattedData.push(rowData);
            }

            formattedData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            console.log(`Parsed ${formattedData.length} valid rows.`);
            return formattedData;
        } catch (error) {
            console.error("Error parsing CSV:", error);
            updateUIOnError(`Error parsing data: ${error.message}. Check console.`);
            return null;
        }
    }

    /** Processes data for unique/duplicate eggs */
    function processEggData(data) {
        // ... (Keep the existing processEggData function) ...
       const seenEggs = new Set();
       const duplicateEggNumbers = new Set();
       for (let i = data.length - 1; i >= 0; i--) { // Iterate oldest first
           const item = data[i];
           if (item.eggNumber) {
               const eggNum = item.eggNumber;
                if (seenEggs.has(eggNum)) { duplicateEggNumbers.add(eggNum); }
                else { seenEggs.add(eggNum); }
           }
       }
       return { uniqueEggsCount: seenEggs.size, duplicateEggNumbers };
    }

    // --- UI Update Functions ---

    /** Helper function to display errors in the UI */
    function updateUIOnError(errorMessage) {
        // ... (Keep the existing updateUIOnError function) ...
        document.getElementById('leaderboard-body').innerHTML = `<tr><td colspan="4" class="text-center py-4 px-4 text-red-600">${errorMessage}</td></tr>`;
        document.getElementById('leader-section').innerHTML = `<div class="placeholder text-red-600 p-4 h-24">${errorMessage}</div>`; // Match increased height
        document.getElementById('recent-activity').innerHTML = `<div class="placeholder text-red-600 p-4 h-24">${errorMessage}</div>`; // Match increased height
        document.getElementById('progress-text').textContent = 'Error';
        document.getElementById('duplicate-warning').textContent = '';
    }

    /** Creates the HTML for an image using the Google Drive Thumbnail method */
    function createImageHtml(imageUrl, altText) {
        // ... (Keep the existing createImageHtml function - it uses the CSS classes) ...
        let fileId = null;

        // --- Logic to extract fileId from imageUrl ---
        try {
            if (typeof imageUrl === 'string' && imageUrl.includes('drive.google.com')) {
                 if (imageUrl.includes('/file/d/')) {
                     const match = imageUrl.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
                     if (match && match[1]) { fileId = match[1]; }
                 } else if (imageUrl.includes('open?id=')) {
                     const urlParams = new URLSearchParams(new URL(imageUrl).search);
                     fileId = urlParams.get('id');
                 } else if (imageUrl.includes('/uc?id=')) {
                      const urlParams = new URLSearchParams(new URL(imageUrl).search);
                     fileId = urlParams.get('id');
                 }
            }
        } catch (e) {
            console.error("Error parsing Google Drive URL:", imageUrl, e);
        }
        // --- End extraction logic ---

        if (!imageUrl || !fileId) {
             console.warn("Could not extract File ID or invalid URL:", imageUrl);
             const fallbackSrc = (typeof imageUrl === 'string' && !imageUrl.includes('drive.google.com')) ? imageUrl : '';
             if (fallbackSrc) {
                 // Attempt to display non-Drive URLs directly
                 return `<img src="${fallbackSrc}" alt="${altText || 'Image'}" class="egg-image" referrerpolicy="no-referrer" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" >` +
                        `<div class="error-placeholder" style="display: none;" title="Image failed to load. Original URL: ${fallbackSrc}">Img Err</div>`;
             } else {
                 // Show error placeholder if it was a Drive link we couldn't parse or empty
                 return `<div class="error-placeholder" title="Invalid or missing Google Drive URL/ID. Original: ${imageUrl || 'N/A'}">No Img</div>`;
             }
        }

        // Construct the thumbnail URL (adjust size 'w200' as needed)
        const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`; // w200 is good for an 80px display
        const errorTitle = `Failed to load thumbnail. URL: ${thumbnailUrl} (Original: ${imageUrl || 'N/A'}) - Check sharing permissions?`;

        // Return the img tag with the thumbnail URL and an error fallback
        return `<img src="${thumbnailUrl}" alt="${altText}" class="egg-image" referrerpolicy="no-referrer" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" >` +
               `<div class="error-placeholder" style="display: none;" title="${errorTitle}">Img Err</div>`;
    }


    /** Updates leaderboard table with duplicate highlighting */
    function updateLeaderboard(data, duplicateEggNumbers) {
        // ... (Keep the existing updateLeaderboard function - it uses createImageHtml) ...
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = '';
        if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 px-4 text-gray-500">No egg finds recorded yet.</td></tr>'; return; }

        data.forEach(item => {
            const row = document.createElement('tr');
            const isDuplicateNumber = item.eggNumber && duplicateEggNumbers.has(item.eggNumber);
             if (isDuplicateNumber) { row.className = 'duplicate-row'; row.title = `Egg ${item.eggNumber} was found more than once!`; }
             else { row.className = 'hover:bg-gray-50'; }

            let formattedDate = 'Invalid Date'; try { const date = new Date(item.timestamp); if (!isNaN(date)) { formattedDate = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }); } } catch(e) {/* ignore */}
            const imageHtml = createImageHtml(item.imageUrl, `Egg ${item.eggNumber || ''}`); // Uses the conversion helper

            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm align-middle">${formattedDate}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium align-middle">${item.name || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm align-middle">${item.eggNumber || 'N/A'}</td>
                <td class="px-4 py-3 align-middle">${imageHtml}</td> `;
            tbody.appendChild(row);
        });
    }

    /** Updates the leader section */
    function updateLeaderSection(data) {
        // ... (Keep the existing updateLeaderSection function - it uses createImageHtml) ...
        const leaderSection = document.getElementById('leader-section');
        if (!data || data.length === 0) { leaderSection.innerHTML = '<div class="placeholder text-gray-500 h-24">No data available</div>'; return; } // Match height
        const playerCounts = {}; const playerLastImageUrl = {};
        data.forEach(item => { if (item.name) { if (!playerCounts[item.name]) { playerCounts[item.name] = 0; playerLastImageUrl[item.name] = item.imageUrl; } playerCounts[item.name]++; } });
        let leader = ''; let maxEggs = 0; let leaderImageUrl = '';
        for (const player in playerCounts) { if (playerCounts[player] > maxEggs) { maxEggs = playerCounts[player]; leader = player; leaderImageUrl = playerLastImageUrl[player]; } }
        if (leader) { const imageHtml = createImageHtml(leaderImageUrl, `Latest find by ${leader}`); leaderSection.innerHTML = `<div class="flex items-center p-3 bg-blue-50 rounded-lg"><div class="mr-4 flex-shrink-0">${imageHtml}</div><div class="flex-grow"><h3 class="font-bold text-lg text-gray-800">${leader}</h3><p class="text-sm text-gray-600">${maxEggs} egg${maxEggs !== 1 ? 's' : ''} found</p></div></div>`; }
        else { leaderSection.innerHTML = '<div class="placeholder text-gray-500 h-24">No leader yet.</div>'; } // Match height
    }

    /** Updates recent activity */
    function updateRecentActivity(data) {
        // ... (Keep the existing updateRecentActivity function - it uses createImageHtml) ...
        const recentActivity = document.getElementById('recent-activity');
        if (!data || data.length === 0) { recentActivity.innerHTML = '<div class="placeholder text-gray-500 h-24">No recent activity</div>'; return; } // Match height
        const mostRecent = data[0];
        if (mostRecent && mostRecent.name) { const imageHtml = createImageHtml(mostRecent.imageUrl, `Egg ${mostRecent.eggNumber || ''}`); recentActivity.innerHTML = `<div class="flex items-center"><div class="mr-3 flex-shrink-0">${imageHtml}</div><div class="flex-grow"><p class="font-semibold text-gray-800">${mostRecent.name}</p><p class="text-sm text-gray-600">Found egg #${mostRecent.eggNumber || '?'}</p></div></div>`; }
        else { recentActivity.innerHTML = '<div class="placeholder text-gray-500 h-24">No valid recent activity found</div>'; } // Match height
    }

    /** Updates progress bar AND duplicate warning message */
    function updateProgressBar(uniqueEggsCount, duplicateEggNumbers) {
        // ... (Keep the existing updateProgressBar function) ...
         const eggsFound = uniqueEggsCount;
         const totalEggs = config.totalEggs > 0 ? config.totalEggs : 1;
         const percentage = Math.min(100, Math.max(0, Math.round((eggsFound / totalEggs) * 100)));
         document.getElementById('progress-bar').style.width = `${percentage}%`;
         document.getElementById('progress-text').textContent = `${eggsFound}/${config.totalEggs} unique eggs found`;
         const warningDiv = document.getElementById('duplicate-warning');
         if (duplicateEggNumbers.size > 0) { const eggList = Array.from(duplicateEggNumbers).slice(0, 5).join(', '); const extra = duplicateEggNumbers.size > 5 ? '...' : ''; warningDiv.textContent = `Warning: Duplicate finds for egg(s) #${eggList}${extra}!`; warningDiv.title = `Full list of duplicates: ${Array.from(duplicateEggNumbers).join(', ')}`; }
         else { warningDiv.textContent = ''; warningDiv.title = ''; }
    }

    /** Starts the refresh timer */
    function startRefreshTimer() {
        // ... (Keep the existing startRefreshTimer function) ...
        if (refreshTimer) { clearInterval(refreshTimer); }
        const intervalMs = Math.max(5000, config.refreshInterval * 1000);
        console.log(`Setting refresh interval to ${intervalMs / 1000} seconds.`);
        refreshTimer = setInterval(fetchData, intervalMs);
    }

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... (Keep the existing DOMContentLoaded listener) ...
        console.log("DOM Loaded. Calling initial fetchData...");
        startRefreshTimer();
        fetchData();
    });
    </script>
</body>
</html>